<!DOCTYPE html>
<html lang="en">

<head>
    <title>Flask_Chat_App</title>
</head>

<body>

    <h3 style='color: #ccc;font-size: 30px;'>No message yet..</h3>
    <div class="message_holder"></div>

    <form action="" method="POST">
        <input type="text" class="username" placeholder="User Name" enctype="multipart/form-data" readonly />
        <input type="text" class="message" placeholder="Messages" enctype="multipart/form-data" />
        <input type="submit" />
    </form>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.7.3/socket.io.min.js"></script>
    <script src="https://peterolson.github.io/BigInteger.js/BigInteger.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/rollups/aes.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha256/0.9.0/sha256.js"></script>
    <script src="static/crypto.js"></script>
    <script>
        const socket = io.connect('http://' + document.domain + ':' + location.port);
        let user = new User(1, 1);
        let myName = '';
        let hashList = [];
        const usersStatus = {};
        function getName() {
            while (!myName || hashList.includes(sha256(myName))) {
                myName = prompt('What is your name?');
            }
            $('input.username').val(myName);
            
        }
        socket.on('connect', () => {
            socket.emit('new user', {});
        });
        socket.on('hash', json => {
            hashList = json.hashes;m
            getName();
            socket.emit('my hash', {
                myHash: sha256(myName)
            });
        });
        socket.on('init', json => {
            user = new User(json.p, json.q);
            console.log('x: ', user.x.value, 'a: ', user.a);
            socket.emit('swap', {
                a: user.a,
                p: user.p,
                q: user.q,
            });
        });
        socket.on('use prev', json => {
            user.usePrev();
            socket.emit('big swap', {
                a: user.a,
                new_id: json.id
            });
        });
        socket.on('new o', json => {
            if (json.a != user.o) {
                console.log('new o: ', json.a);
                user.calcKey(json.a);
                console.log('key: ', user.key, 'p, q:', user.p.value, user.q.value);
                socket.emit('join', {
                    user_name: user.encrypt(myName)
                });
            }
        });
        $('form').on('submit', e => {
            e.preventDefault();
            let user_name = $('input.username').val();
            let user_input = $('input.message').val();
            socket.emit('msg', {
                user_name: user.encrypt(user_name),
                message: user.encrypt(user_input)
            });
            $('input.message').val('').focus();
        });
        socket.on('new msg', json => {
            if (typeof json.user_name !== 'undefined') {
                console.log('incoming');
                console.log(json);
                const uname = user.decrypt(json.user_name);
                const msg = user.decrypt(json.message);
                $('h3').remove();
                $('div.message_holder').append('<div><b style="color: #000">' + uname + '</b> ' + msg +
                    '</div>');
            }
        });
        socket.on('join', json => {
            if (typeof json.user_name !== 'undefined') {
                const uname = user.decrypt(json.user_name);
                if (!(uname in usersStatus)) {
                    $('h3').remove();
                    if (uname.length >= 1) {
                        $('div.message_holder').append('<div><b style="color: #000">' + uname +
                            ' connected</b></div>');
                    }
                    usersStatus[uname] = true;
                }
            }
        });
        socket.on('leave', json => {
            if (typeof json.user_name !== 'undefined') {
                const uname = user.decrypt(json.user_name);
                if (uname in usersStatus) {
                    $('h3').remove();
                    if (uname.length >= 1) {
                        $('div.message_holder').append('<div><b style="color: #000">' + uname +
                            ' disconnected</b></div>');
                    }
                    delete usersStatus[uname];
                }
            }
        });
    </script>

</body>

</html>